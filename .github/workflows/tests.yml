name: CI

on:
  push:
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend_jest:
    name: Frontend Jest (coverage)
    runs-on: ubuntu-latest
    continue-on-error: true # Temporarily soft-fail until ts-jest is added to devDependencies
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (root)
        run: npm ci

      - name: Run Jest with coverage (frontend)
        run: npm run test:coverage -- --ci

      - name: Upload coverage artifact (frontend)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: |
            coverage
            coverage/**
          if-no-files-found: warn

  backend_jest:
    name: Backend Jest (coverage)
    runs-on: ubuntu-latest
    needs: frontend_jest
    continue-on-error: true # Soft-fail initially to avoid blocking Epic 002 work
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (backend)
        run: npm ci --prefix backend

      - name: Run Jest with coverage (backend)
        run: npm --prefix backend run test:coverage -- --ci

      - name: Upload coverage artifact (backend)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: |
            backend/coverage
            backend/coverage/**
          if-no-files-found: warn

  playwright_e2e:
    name: Playwright E2E
    runs-on: ubuntu-latest
    needs: frontend_jest
    continue-on-error: true # Temporarily soft-fail until Epic 002 auth is finalized
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (root)
        run: npm ci

      - name: Install dependencies (backend)
        run: npm ci --prefix backend

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        env:
          CI: 'true'
        run: npx playwright test --reporter=line

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report
            playwright-report/**
          if-no-files-found: warn

      - name: Upload raw test results (json/junit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            test-results
            test-results/**
          if-no-files-found: warn